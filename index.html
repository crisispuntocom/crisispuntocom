<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Super APP - Radios, Finanzas & Clima</title>
  
  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#111111">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Super APP">
  <meta name="description" content="Radios online, datos financieros y clima en tiempo real">
  
  <!-- PWA Icons -->
  <link rel="icon" type="image/png" sizes="32x32" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' fill='%23111'/><text x='50' y='60' font-family='Arial' font-size='60' fill='white' text-anchor='middle'>S</text></svg>">
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'><rect width='192' height='192' fill='%23111'/><text x='96' y='120' font-family='Arial' font-size='100' fill='white' text-anchor='middle'>S</text></svg>">
  
  <!-- Manifest -->
  <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIlN1cGVyIEFQUCAtIFJhZGlvcywgRmluYW56YXMgJiBDbGltYSIsCiAgInNob3J0X25hbWUiOiAiU3VwZXIgQVBQIiwKICAiZGVzY3JpcHRpb24iOiAiUmFkaW9zIG9ubGluZSwgZGF0b3MgZmluYW5jaWVyb3MgeSBjbGltYSBlbiB0aWVtcG8gcmVhbCIsCiAgInN0YXJ0X3VybCI6ICIvIiwKICAiZGlzcGxheSI6ICJzdGFuZGFsb25lIiwKICAiYmFja2dyb3VuZF9jb2xvciI6ICIjZmZmZmZmIiwKICAidGhlbWVfY29sb3IiOiAiIzExMTExMSIsCiAgImljb25zIjogWwogICAgewogICAgICAic3JjIjogImRhdGE6aW1hZ2Uvc3ZnK3htbCwlM0NzdmcgeG1sbnM9J2h0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnJyB2aWV3Qm94PSczIDMgMTkyIDE5MiclM0UlM0NyZWN0IHdpZHRoPScxOTInIGhlaWdodD0nMTkyJyBmaWxsPSclMjMxMTEnLyUzRSUzQ3RleHQgeD0nOTYnIHk9JzEyMCcgZm9udC1mYW1pbHk9J0FyaWFsJyBmb250LXNpemU9JzEwMCcgZmlsbD0nd2hpdGUnIHRleHQtYW5jaG9yPSdtaWRkbGUnJTNFUyUzQy90ZXh0JTNFJTNDL3N2ZyUzRSIsCiAgICAgICJzaXplcyI6ICIxOTJ4MTkyIiwKICAgICAgInR5cGUiOiAiaW1hZ2Uvc3ZnK3htbCIKICAgIH0sCiAgICB7CiAgICAgICJzcmMiOiAiZGF0YTppbWFnZS9zdmcreG1sLCUzQ3N2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHZpZXdCb3g9JzAgMCA1MTIgNTEyJyUzRSUzQ3JlY3Qgd2lkdGg9JzUxMicgaGVpZ2h0PSc1MTInIGZpbGw9JyUyMzExMScvJTNFJTNDdGV4dCB4PSc2NicgeT0nMzIwJyBmb250LWZhbWlseT0nQXJpYWwnIGZvbnQtc2l6ZT0nMjgwJyBmaWxsPSd3aGl0ZScgdGV4dC1hbmNob3I9J21pZGRsZSclM0VTJTNDL3RleHQlM0UlM0Mvc3ZnJTNFIiwKICAgICAgInNpemVzIjogIjUxMng1MTIiLAogICAgICAidHlwZSI6ICJpbWFnZS9zdmcreG1sIgogICAgfQogIF0KfQ==">
  
  <style>
    body {
      background: #fff;
      color: #111;
      font-family: 'Segoe UI', Arial, sans-serif;
      margin: 0;
      padding: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      user-select: none;
      -webkit-user-select: none;
      -webkit-touch-callout: none;
    }
    
    /* PWA Install Banner */
    .install-banner {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: linear-gradient(135deg, #111, #333);
      color: white;
      padding: 0.8rem;
      text-align: center;
      z-index: 1000;
      transform: translateY(-100%);
      transition: transform 0.3s ease;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }
    .install-banner.show {
      transform: translateY(0);
    }
    .install-btn {
      background: #fff;
      color: #111;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-weight: bold;
      margin-left: 1rem;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .install-btn:hover {
      transform: scale(1.05);
    }
    .close-banner {
      position: absolute;
      right: 1rem;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      color: white;
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0.2rem;
    }
    
    /* Offline Indicator */
    .offline-indicator {
      position: fixed;
      top: 10px;
      right: 10px;
      background: #ff4444;
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-size: 0.9rem;
      display: none;
      z-index: 999;
      animation: pulse 2s infinite;
    }
    .offline-indicator.show {
      display: block;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    
    .tabs {
      display: flex;
      border-bottom: 2px solid #111;
      background: #fff;
      position: sticky;
      top: 0;
      z-index: 10;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .tab-btn {
      flex: 1;
      padding: 1rem;
      background: #fff;
      color: #111;
      border: none;
      border-right: 1px solid #e2e2e2;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    .tab-btn:last-child { border-right: none; }
    .tab-btn.active {
      background: #111;
      color: #fff;
      transform: translateY(-2px);
    }
    .tab-btn:hover:not(.active) {
      background: #f5f5f5;
      transform: translateY(-1px);
    }
    
    .tab-content {
      display: none;
      padding: 2rem 1rem 6rem 1rem;
      max-width: 500px;
      margin: 0 auto;
      opacity: 0;
      transform: translateY(20px);
      transition: all 0.3s ease;
    }
    .tab-content.active {
      display: block;
      opacity: 1;
      transform: translateY(0);
    }
    
    .stations {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      width: 100%;
      max-width: 320px;
      margin: 2rem auto 0 auto;
    }
    .station-btn {
      background: #fff;
      color: #111;
      border: 2px solid #111;
      border-radius: 12px;
      padding: 1.2rem;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s ease;
      width: 100%;
      position: relative;
      overflow: hidden;
    }
    .station-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    .station-btn.active, .station-btn:focus {
      background: #111;
      color: #fff;
      outline: none;
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }
    
    .sp500-box {
      border: 2px solid #111;
      border-radius: 12px;
      padding: 1.5rem;
      margin: 1.5rem 0;
      text-align: center;
      font-size: 1.2rem;
      background: linear-gradient(135deg, #fafafa, #f0f0f0);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    .sp500-box:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    .sp500-big {
      font-size: 2.2rem;
      font-weight: bold;
      margin: 0.5rem 0;
    }
    .sp500-variation {
      font-size: 1.1rem;
      margin-top: 0.5rem;
      font-weight: 600;
    }
    
    .radio-summary {
      margin: 1.5rem 0 0.5rem 0;
      font-size: 1.1rem;
      text-align: center;
      padding: 1rem;
      background: linear-gradient(135deg, #f8f8f8, #e8e8e8);
      border-radius: 12px;
      border: 1px solid #ddd;
    }
    
    .clock {
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 2rem 0 0 0;
    }
    .clock-canvas {
      background: #fff;
      border: 3px solid #111;
      border-radius: 50%;
      width: 140px;
      height: 140px;
      display: block;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      transition: transform 0.3s ease;
    }
    .clock-canvas:hover {
      transform: scale(1.05);
    }
    
    .audio-bar {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, #fff, #f5f5f5);
      border-top: 2px solid #111;
      padding: 0.8rem 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
    }
    .audio-bar audio {
      width: 100%;
      max-width: 400px;
      outline: none;
      border-radius: 8px;
    }
    
    .weather-section {
      margin-bottom: 2.5rem;
    }
    .weather-title {
      font-size: 1.2rem;
      font-weight: bold;
      margin-bottom: 0.8rem;
      margin-top: 1.5rem;
      color: #111;
    }
    .weather-current {
      font-size: 1.3rem;
      margin-bottom: 1rem;
      padding: 1rem;
      background: linear-gradient(135deg, #e3f2fd, #bbdefb);
      border-radius: 12px;
      border: 1px solid #90caf9;
    }
    .weather-hourly {
      display: flex;
      overflow-x: auto;
      gap: 0.8rem;
      margin-bottom: 1.5rem;
      padding: 0.5rem 0;
    }
    .weather-hour {
      min-width: 80px;
      border: 1px solid #111;
      border-radius: 12px;
      padding: 0.8rem;
      text-align: center;
      background: linear-gradient(135deg, #fafafa, #f0f0f0);
      font-size: 0.95rem;
      transition: transform 0.2s ease;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .weather-hour:hover {
      transform: translateY(-2px);
    }
    .weather-week {
      display: flex;
      gap: 0.8rem;
      flex-wrap: wrap;
      margin-bottom: 1.5rem;
    }
    .weather-day {
      flex: 1 1 100px;
      border: 1px solid #111;
      border-radius: 12px;
      padding: 0.8rem;
      text-align: center;
      background: linear-gradient(135deg, #fafafa, #f0f0f0);
      font-size: 0.95rem;
      margin-bottom: 0.5rem;
      transition: transform 0.2s ease;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .weather-day:hover {
      transform: translateY(-2px);
    }
    
    /* Loading Animation */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #111;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Responsive Design */
    @media (max-width: 500px) {
      .tab-content { padding: 1rem 0.5rem 6rem 0.5rem; }
      .audio-bar audio { max-width: 95vw; }
      .clock-canvas { width: 100px; height: 100px; }
      .weather-hour, .weather-day { min-width: 60px; font-size: 0.9rem; }
      .sp500-big { font-size: 1.8rem; }
      .tab-btn { font-size: 0.9rem; padding: 0.8rem; }
    }
    
    /* Dark mode support */
    @media (prefers-color-scheme: dark) {
      body {
        background: #1a1a1a;
        color: #fff;
      }
      .tab-btn {
        background: #2a2a2a;
        color: #fff;
        border-color: #444;
      }
      .tab-btn.active {
        background: #fff;
        color: #111;
      }
      .sp500-box {
        background: linear-gradient(135deg, #2a2a2a, #333);
        border-color: #555;
      }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.7/dist/hls.min.js"></script>
</head>
<body>
  <!-- PWA Install Banner -->
  <div id="installBanner" class="install-banner">
    <span>üì± Instalar Super APP en tu dispositivo</span>
    <button id="installBtn" class="install-btn">Instalar</button>
    <button id="closeBanner" class="close-banner">√ó</button>
  </div>
  
  <!-- Offline Indicator -->
  <div id="offlineIndicator" class="offline-indicator">
    üìµ Sin conexi√≥n
  </div>

  <nav class="tabs">
    <button class="tab-btn active" data-tab="home">üè† Inicio</button>
    <button class="tab-btn" data-tab="radios">üìª Radios</button>
    <button class="tab-btn" data-tab="sp500">üí∞ Finanzas</button>
    <button class="tab-btn" data-tab="clima">üå§Ô∏è Clima</button>
    <button class="tab-btn" data-tab="crisis">üì∞ Crisis</button>
  </nav>

  <section class="tab-content active" id="tab-home">
    <div class="radio-summary">
      <span>üéµ Radio sonando: <b id="current-radio">Ninguna</b></span>
    </div>
    <div class="sp500-box">
      <div>üìà S&P 500 (ETF: SPY)</div>
      <div class="sp500-big" id="sp500-home-price">Cargando...</div>
      <div class="sp500-variation" id="sp500-home-var"> </div>
    </div>
    <div class="sp500-box">
      <div>ü•á Oro (ETF: GLD)</div>
      <div class="sp500-big" id="gld-home-price">Cargando...</div>
      <div class="sp500-variation" id="gld-home-var"> </div>
    </div>
    <div class="weather-title">üå°Ô∏è Clima actual</div>
    <div id="weather-home"></div>
    <div class="clock">
      <canvas id="clock-canvas" class="clock-canvas" width="140" height="140"></canvas>
    </div>
  </section>

  <section class="tab-content" id="tab-radios">
    <h2 style="text-align:center; font-size:1.3rem; margin-bottom:1.5rem;">üìª Radios Online</h2>
    <div class="stations">
      <button class="station-btn" data-url="https://mdstrm.com/audio/5d9d019112cbbb45d6a50960/live.m3u8" data-type="hls">üéµ Futurock FM</button>
      <button class="station-btn" data-url="https://playerservices.streamtheworld.com/api/livestream-redirect/BLACKIE_89_1.mp3" data-type="mp3">üé∏ Blackie FM</button>
      <button class="station-btn" data-url="https://cdn.instream.audio:9660/stream" data-type="mp3">üèôÔ∏è Urbana Play</button>
    </div>
  </section>

  <section class="tab-content" id="tab-sp500">
    <h2 style="text-align:center; font-size:1.3rem; margin-bottom:1.5rem;">üí∞ Finanzas</h2>
    <div class="sp500-box">
      <div>üìà S&P 500 (ETF: SPY)</div>
      <div class="sp500-big" id="sp500-price">Cargando...</div>
      <div class="sp500-variation" id="sp500-var"> </div>
    </div>
    <div class="sp500-box">
      <div>ü•á Oro (ETF: GLD)</div>
      <div class="sp500-big" id="gld-price">Cargando...</div>
      <div class="sp500-variation" id="gld-var"> </div>
    </div>
  </section>

  <section class="tab-content" id="tab-clima">
    <h2 style="text-align:center; font-size:1.3rem; margin-bottom:1.5rem;">üå§Ô∏è Clima</h2>
    <div id="weather-moron" class="weather-section"></div>
    <div id="weather-caba" class="weather-section"></div>
  </section>

  <section class="tab-content" id="tab-crisis">
    <h2 style="text-align:center; font-size:1.3rem; margin-bottom:2rem;">üì∞ CrisisPuntoCom</h2>
    <div id="crisis-list" style="max-width:600px; margin:0 auto; padding:1rem;"></div>
    <div style="text-align:center; margin-top:2rem; color:#666; font-size:1rem;">
      Si no ves los art√≠culos, abr√≠ <a href="https://crisispuntocom.substack.com/" target="_blank" rel="noopener noreferrer">CrisisPuntoCom</a> directamente.
    </div>
  </section>

  <div class="audio-bar">
    <audio id="player" controls preload="none"></audio>
  </div>

  <script>
    // Service Worker Registration
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('data:application/javascript;base64,Ly8gU2VydmljZSBXb3JrZXIgZm9yIFBXQQpjb25zdCBDQUNIRV9OQU1FID0gJ3N1cGVyLWFwcC12MSc7CmNvbnN0IHVybHNUb0NhY2hlID0gWwogICcvJywKICAnaHR0cHM6Ly9jZG4uanNkZWxpdnIubmV0L25wbS9obHMuanNAMS41LjcvZGlzdC9obHMubWluLmpzJwpdOwoKc2VsZi5hZGRFdmVudExpc3RlbmVyKCdpbnN0YWxsJywgZXZlbnQgPT4gewogIGV2ZW50LndhaXRVbnRpbCgKICAgIGNhY2hlcy5vcGVuKENBQ0hFX05BTUUpCiAgICAgIC50aGVuKGNhY2hlID0+IGNhY2hlLmFkZEFsbCh1cmxzVG9DYWNoZSkpCiAgKTsKfSk7CgpzZWxmLmFkZEV2ZW50TGlzdGVuZXIoJ2ZldGNoJywgZXZlbnQgPT4gewogIGV2ZW50LnJlc3BvbmRXaXRoKAogICAgY2FjaGVzLm1hdGNoKGV2ZW50LnJlcXVlc3QpCiAgICAgIC50aGVuKHJlc3BvbnNlID0+IHsKICAgICAgICBpZiAocmVzcG9uc2UpIHsKICAgICAgICAgIHJldHVybiByZXNwb25zZTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZldGNoKGV2ZW50LnJlcXVlc3QpOwogICAgICB9KQogICk7Cn0pOw==')
        .then(() => console.log('Service Worker registrado'))
        .catch(err => console.log('Error al registrar Service Worker:', err));
    }

    // PWA Install Banner
    let deferredPrompt;
    const installBanner = document.getElementById('installBanner');
    const installBtn = document.getElementById('installBtn');
    const closeBanner = document.getElementById('closeBanner');

    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      installBanner.classList.add('show');
    });

    installBtn.addEventListener('click', async () => {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        console.log(`User response: ${outcome}`);
        deferredPrompt = null;
        installBanner.classList.remove('show');
      }
    });

    closeBanner.addEventListener('click', () => {
      installBanner.classList.remove('show');
    });

    // Online/Offline Detection
    const offlineIndicator = document.getElementById('offlineIndicator');
    
    function updateOnlineStatus() {
      if (navigator.onLine) {
        offlineIndicator.classList.remove('show');
      } else {
        offlineIndicator.classList.add('show');
      }
    }
    
    window.addEventListener('online', updateOnlineStatus);
    window.addEventListener('offline', updateOnlineStatus);
    updateOnlineStatus();

    // Tabs with smooth transitions
    const tabBtns = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');
    
    tabBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        tabBtns.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        const tab = btn.getAttribute('data-tab');
        
        tabContents.forEach(tc => {
          tc.classList.remove('active');
          tc.style.display = 'none';
        });
        
        setTimeout(() => {
          const activeTab = document.getElementById('tab-' + tab);
          activeTab.style.display = 'block';
          setTimeout(() => activeTab.classList.add('active'), 10);
        }, 150);
      });
    });

    // Radios
    const buttons = document.querySelectorAll('.station-btn');
    const player = document.getElementById('player');
    let currentBtn = null;
    let hls = null;
    let currentRadioName = 'Ninguna';
    const currentRadioSpan = document.getElementById('current-radio');

    function playStream(url, type, name) {
      if (hls) {
        hls.destroy();
        hls = null;
      }
      if (type === 'hls' && Hls.isSupported()) {
        hls = new Hls();
        hls.loadSource(url);
        hls.attachMedia(player);
        hls.on(Hls.Events.MANIFEST_PARSED, function() {
          player.play().catch(e => console.log('Error al reproducir:', e));
        });
      } else {
        player.src = url;
        player.play().catch(e => console.log('Error al reproducir:', e));
      }
      currentRadioName = name;
      currentRadioSpan.textContent = name;
      
      // Haptic feedback on mobile
      if (navigator.vibrate) {
        navigator.vibrate(50);
      }
    }

    buttons.forEach(btn => {
      btn.addEventListener('click', () => {
        const url = btn.getAttribute('data-url');
        const type = btn.getAttribute('data-type');
        const name = btn.textContent.replace(/üéµ|üé∏|üèôÔ∏è/g, '').trim();
        playStream(url, type, name);
        if (currentBtn) currentBtn.classList.remove('active');
        btn.classList.add('active');
        currentBtn = btn;
      });
    });

    // Financial Data with better error handling
    async function fetchFinancialData(symbol, priceElementId, varElementId, homePriceId, homeVarId) {
      try {
        const res = await fetch(`https://corsproxy.io/?https://api.twelvedata.com/quote?symbol=${symbol}&apikey=2a68f57e10034133aece36e481a25207`);
        const data = await res.json();
        
        if (!data.close || !data.previous_close || isNaN(parseFloat(data.close)) || isNaN(parseFloat(data.previous_close))) {
          throw new Error('Datos no disponibles');
        }
        
        const price = parseFloat(data.close);
        const diff = parseFloat(data.change);
        const pct = parseFloat(data.percent_change);
        
        const priceStr = price.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        const diffStr = (diff >= 0 ? '+' : '') + diff.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        const pctStr = (pct >= 0 ? '+' : '') + pct.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + '%';
        
        // Color coding for positive/negative changes
        const color = diff >= 0 ? '#4CAF50' : '#F44336';
        
        // Update elements
        document.getElementById(priceElementId).textContent = priceStr;
        document.getElementById(varElementId).innerHTML = `<span style="color: ${color}">${diffStr} (${pctStr})</span>`;
        document.getElementById(homePriceId).textContent = priceStr;
        document.getElementById(homeVarId).innerHTML = `<span style="color: ${color}">${diffStr} (${pctStr})</span>`;
        
      } catch (e) {
        const errorMsg = navigator.onLine ? 'Error' : 'Sin conexi√≥n';
        document.getElementById(priceElementId).textContent = errorMsg;
        document.getElementById(varElementId).textContent = '';
        document.getElementById(homePriceId).textContent = errorMsg;
        document.getElementById(homeVarId).textContent = '';
        console.error(`Error al obtener ${symbol}:`, e);
      }
    }

    // Fetch S&P 500 and Gold data
    fetchFinancialData('SPY', 'sp500-price', 'sp500-var', 'sp500-home-price', 'sp500-home-var');
    fetchFinancialData('GLD', 'gld-price', 'gld-var', 'gld-home-price', 'gld-home-var');
    
    // Update financial data every minute
    setInterval(() => {
      if (navigator.onLine) {
        fetchFinancialData('SPY', 'sp500-price', 'sp500-var', 'sp500-home-price', 'sp500-home-var');
        fetchFinancialData('GLD', 'gld-price', 'gld-var', 'gld-home-price', 'gld-home-var');
      }
    }, 60000);

    // Weather functions
    function getWeatherState(precip) {
      if (precip >= 2) return '‚õàÔ∏è Tormenta';
      if (precip > 0) return 'üåßÔ∏è Lluvia';
      return '‚òÄÔ∏è Soleado';
    }
    
    function getHourLabel(dt) {
      return dt.split('T')[1].slice(0,5);
    }
    
    function getDayLabel(dt) {
      const dias = ['Dom','Lun','Mar','Mi√©','Jue','Vie','S√°b'];
      const d = new Date(dt);
      return dias[d.getDay()] + ' ' + d.getDate();
    }
    
    async function fetchWeather(city, lat, lon, elId, homeId) {
      try {
        const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,precipitation&hourly=temperature_2m,precipitation&daily=temperature_2m_max,temperature_2m_min,precipitation_sum&timezone=America/Argentina/Buenos_Aires`;
        const res = await fetch(url);
        const data = await res.json();
        
        // Current weather
        const temp = Math.round(data.current.temperature_2m);
        const precip = data.current.precipitation;
        const state = getWeatherState(precip);
        
        // Home summary
        if (homeId) {
          document.getElementById(homeId).innerHTML = `<div class="weather-current"><b>üìç ${city}:</b> ${temp}¬∞C, ${state}</div>`;
        }
        
        // Detailed weather
        let html = `<div class="weather-title">üìç ${city}</div>`;
        html += `<div class="weather-current">Actual: <b>${temp}¬∞C</b>, ${state}</div>`;
        
        // Hourly forecast (next 12 hours)
        html += `<div class="weather-title">‚è∞ Por hora</div><div class="weather-hourly">`;
        for (let i = 0; i < 12; i++) {
          const t = Math.round(data.hourly.temperature_2m[i]);
          const p = data.hourly.precipitation[i];
          const st = getWeatherState(p);
          const label = getHourLabel(data.hourly.time[i]);
          html += `<div class="weather-hour"><div><b>${label}</b></div><div>${t}¬∞C</div><div>${st}</div></div>`;
        }
        html += `</div>`;
        
        // Weekly forecast
        html += `<div class="weather-title">üìÖ Semana</div><div class="weather-week">`;
        for (let i = 0; i < Math.min(data.daily.temperature_2m_max.length, 7); i++) {
          const tmax = Math.round(data.daily.temperature_2m_max[i]);
          const tmin = Math.round(data.daily.temperature_2m_min[i]);
          const p = data.daily.precipitation_sum[i];
          const st = getWeatherState(p);
          const label = getDayLabel(data.daily.time[i]);
          html += `<div class="weather-day"><div><b>${label}</b></div><div>${tmax}¬∞C / ${tmin}¬∞C</div><div>${st}</div></div>`;
        }
        html += `</div>`;
        
        document.getElementById(elId).innerHTML = html;
        
      } catch (e) {
        const errorMsg = navigator.onLine ? 'Error al cargar clima' : 'Sin conexi√≥n - Clima no disponible';
        document.getElementById(elId).innerHTML = `<div class="weather-current">${errorMsg}</div>`;
        if (homeId) {
          document.getElementById(homeId).innerHTML = `<div class="weather-current">${errorMsg}</div>`;
        }
        console.error(`Error al obtener clima de ${city}:`, e);
      }
    }
    
    // Fetch weather data
    fetchWeather('Mor√≥n', -34.6512, -58.6221, 'weather-moron', 'weather-home-moron');
    fetchWeather('CABA', -34.6131, -58.3772, 'weather-caba', 'weather-home-caba');
    
    // Setup home weather container
    document.getElementById('weather-home').innerHTML = '<div id="weather-home-moron"></div><div id="weather-home-caba"></div>';

    // Analog Clock with enhanced design
    const canvas = document.getElementById('clock-canvas');
    const ctx = canvas.getContext('2d');
    
    function drawClock() {
      const now = new Date();
      const w = canvas.width;
      const h = canvas.height;
      const centerX = w / 2;
      const centerY = h / 2;
      const radius = w / 2 - 10;
      
      // Clear canvas
      ctx.clearRect(0, 0, w, h);
      
      // Draw outer circle
      ctx.beginPath();
      ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
      ctx.strokeStyle = '#111';
      ctx.lineWidth = 3;
      ctx.stroke();
      
      // Draw hour markers
      for (let i = 0; i < 12; i++) {
        const angle = (i - 3) * (Math.PI * 2) / 12;
        const x1 = centerX + Math.cos(angle) * (radius - 15);
        const y1 = centerY + Math.sin(angle) * (radius - 15);
        const x2 = centerX + Math.cos(angle) * (radius - 5);
        const y2 = centerY + Math.sin(angle) * (radius - 5);
        
        ctx.beginPath();
        ctx.moveTo(x1, y1);
        ctx.lineTo(x2, y2);
        ctx.strokeStyle = '#111';
        ctx.lineWidth = 3;
        ctx.stroke();
      }
      
      // Draw minute markers
      for (let i = 0; i < 60; i++) {
        if (i % 5 !== 0) {
          const angle = (i - 15) * (Math.PI * 2) / 60;
          const x1 = centerX + Math.cos(angle) * (radius - 8);
          const y1 = centerY + Math.sin(angle) * (radius - 8);
          const x2 = centerX + Math.cos(angle) * (radius - 3);
          const y2 = centerY + Math.sin(angle) * (radius - 3);
          
          ctx.beginPath();
          ctx.moveTo(x1, y1);
          ctx.lineTo(x2, y2);
          ctx.strokeStyle = '#111';
          ctx.lineWidth = 1;
          ctx.stroke();
        }
      }
      
      // Calculate angles
      const hours = now.getHours() % 12;
      const minutes = now.getMinutes();
      const seconds = now.getSeconds();
      
      const hourAngle = (hours + minutes / 60) * (Math.PI * 2) / 12 - Math.PI / 2;
      const minuteAngle = minutes * (Math.PI * 2) / 60 - Math.PI / 2;
      const secondAngle = seconds * (Math.PI * 2) / 60 - Math.PI / 2;
      
      // Draw hour hand
      ctx.beginPath();
      ctx.moveTo(centerX, centerY);
      ctx.lineTo(
        centerX + Math.cos(hourAngle) * (radius - 40),
        centerY + Math.sin(hourAngle) * (radius - 40)
      );
      ctx.strokeStyle = '#111';
      ctx.lineWidth = 6;
      ctx.lineCap = 'round';
      ctx.stroke();
      
      // Draw minute hand
      ctx.beginPath();
      ctx.moveTo(centerX, centerY);
      ctx.lineTo(
        centerX + Math.cos(minuteAngle) * (radius - 20),
        centerY + Math.sin(minuteAngle) * (radius - 20)
      );
      ctx.strokeStyle = '#111';
      ctx.lineWidth = 4;
      ctx.lineCap = 'round';
      ctx.stroke();
      
      // Draw second hand
      ctx.beginPath();
      ctx.moveTo(centerX, centerY);
      ctx.lineTo(
        centerX + Math.cos(secondAngle) * (radius - 15),
        centerY + Math.sin(secondAngle) * (radius - 15)
      );
      ctx.strokeStyle = '#ff4444';
      ctx.lineWidth = 2;
      ctx.lineCap = 'round';
      ctx.stroke();
      
      // Draw center dot
      ctx.beginPath();
      ctx.arc(centerX, centerY, 6, 0, 2 * Math.PI);
      ctx.fillStyle = '#111';
      ctx.fill();
      
      // Draw small center dot
      ctx.beginPath();
      ctx.arc(centerX, centerY, 3, 0, 2 * Math.PI);
      ctx.fillStyle = '#ff4444';
      ctx.fill();
    }
    
    // Update clock every second
    setInterval(drawClock, 1000);
    drawClock();

    // CrisisPuntoCom RSS Feed
    async function fetchCrisisRSS() {
      const container = document.getElementById('crisis-list');
      container.innerHTML = '<div style="text-align: center; padding: 2rem;"><div class="loading"></div><br>Cargando art√≠culos...</div>';
      
      try {
        const res = await fetch('https://corsproxy.io/?https://crisispuntocom.substack.com/feed');
        const text = await res.text();
        const parser = new window.DOMParser();
        const xml = parser.parseFromString(text, 'text/xml');
        const items = Array.from(xml.querySelectorAll('item'));
        
        if (!items.length) throw new Error('No hay art√≠culos disponibles');
        
        let html = '<div style="display: flex; flex-direction: column; gap: 1.5rem;">';
        items.slice(0, 10).forEach((item, index) => {
          const title = item.querySelector('title')?.textContent || 'Sin t√≠tulo';
          const link = item.querySelector('link')?.textContent || '#';
          const pubDate = new Date(item.querySelector('pubDate')?.textContent || Date.now());
          const dateStr = pubDate.toLocaleDateString('es-AR', { 
            year: 'numeric', 
            month: 'short', 
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          });
          
          html += `
            <article style="
              padding: 1.5rem;
              border: 2px solid #111;
              border-radius: 12px;
              background: linear-gradient(135deg, #fafafa, #f0f0f0);
              transition: all 0.3s ease;
              cursor: pointer;
            " onclick="window.open('${link}', '_blank')">
              <h3 style="
                margin: 0 0 0.5rem 0;
                font-size: 1.1rem;
                color: #111;
                line-height: 1.4;
              ">${title}</h3>
              <time style="
                color: #666;
                font-size: 0.9rem;
                display: flex;
                align-items: center;
                gap: 0.5rem;
              ">
                üìÖ ${dateStr}
              </time>
            </article>
          `;
        });
        html += '</div>';
        
        container.innerHTML = html;
        
        // Add hover effects
        const articles = container.querySelectorAll('article');
        articles.forEach(article => {
          article.addEventListener('mouseenter', () => {
            article.style.transform = 'translateY(-2px)';
            article.style.boxShadow = '0 4px 15px rgba(0,0,0,0.2)';
          });
          article.addEventListener('mouseleave', () => {
            article.style.transform = 'translateY(0)';
            article.style.boxShadow = 'none';
          });
        });
        
      } catch (e) {
        const errorMessage = navigator.onLine ? 
          'No se pudieron cargar los art√≠culos. Intenta m√°s tarde.' : 
          'Sin conexi√≥n. No se pueden cargar los art√≠culos.';
        container.innerHTML = `<div style="text-align: center; padding: 2rem; color: #666;">${errorMessage}</div>`;
        console.error('Error al obtener RSS CrisisPuntoCom:', e);
      }
    }
    
    // Load Crisis articles when tab is clicked
    document.querySelector('[data-tab="crisis"]').addEventListener('click', fetchCrisisRSS);

    // Prevent context menu on long press (mobile)
    document.addEventListener('contextmenu', e => e.preventDefault());
    
    // Add touch feedback
    document.addEventListener('touchstart', () => {}, { passive: true });
    
    // Handle app being added to home screen
    window.addEventListener('appinstalled', () => {
      console.log('PWA installed successfully');
      installBanner.classList.remove('show');
    });
    
    // Preload critical resources
    const preloadLinks = [
      'https://cdn.jsdelivr.net/npm/hls.js@1.5.7/dist/hls.min.js'
    ];
    
    preloadLinks.forEach(url => {
      const link = document.createElement('link');
      link.rel = 'preload';
      link.as = 'script';
      link.href = url;
      document.head.appendChild(link);
    });
    
    console.log('Super APP PWA loaded successfully! üöÄ');
  </script>
</body>
</html>
